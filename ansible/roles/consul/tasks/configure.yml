---
- name: Create consul user
  user:
    name: "{{ consul_user }}"
    system: yes
    shell: /bin/false

- name: Add default user to consul group
  user:
    name: "{{ ansible_user }}"
    groups: consul
    append: yes

- name: Create consul directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: 0755
  loop:
    - "{{ consul_config_dir }}"
    - "{{ consul_config_dir }}/certs" 
    - "{{ consul_data_dir }}"

# TLS certificates
- name: Copy CA certificate
  copy:
    src: /tmp/consul-certs/consul-agent-ca.pem
    dest: "{{ consul_config_dir }}/certs/consul-agent-ca.pem"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: '0644'
    remote_src: true

- name: Copy server TLS files
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: "{{ item.mode }}"
    remote_src: true
  loop:
    - { src: "/tmp/consul-certs/{{ consul_datacenter }}-server-consul-0.pem", dest: "{{ consul_config_dir }}/certs/server.pem", mode: '0644' }
    - { src: "/tmp/consul-certs/{{ consul_datacenter }}-server-consul-0-key.pem", dest: "{{ consul_config_dir }}/certs/server-key.pem", mode: '0640' }
  when: consul_mode == "server"
  

- name: Copy client TLS files
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: "{{ item.mode }}"
    remote_src: true
  loop:
    - { src: "/tmp/consul-certs/{{ consul_datacenter }}-client-consul-0.pem", dest: "{{ consul_config_dir }}/certs/client.pem", mode: '0644' }
    - { src: "/tmp/consul-certs/{{ consul_datacenter }}-client-consul-0-key.pem", dest: "{{ consul_config_dir }}/certs/client-key.pem", mode: '0640' }
  when: consul_mode == "client"

- name: Deploy Consul server config
  template:
    src: server_consul.hcl.j2
    dest: "{{ consul_config_dir }}/consul.hcl"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: '0644' 
  when: consul_mode == "server"
  register: server_config_changed
  notify: Restart consul

- name: Deploy Consul client config
  template:
    src: client_consul.hcl.j2
    dest: "{{ consul_config_dir }}/consul.hcl"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: '0644'
  when: consul_mode == "client"
  notify: Restart consul

# TO CHANGE [Service] Type=notify FOR Type=simple
- name: Create systemd override directory for Consul
  file:
    path: /etc/systemd/system/consul.service.d
    state: directory
    mode: '0755'

- name: Override Consul service type 
  copy:
    content: |
      [Service]
      Type=
      Type=simple
    dest: /etc/systemd/system/consul.service.d/override.conf
    mode: '0644'
  register: override_created

- name: Reload systemd daemon immediately
  systemd:
    daemon_reload: yes
  when: override_created.changed

- name: Restart consul if override changed
  systemd:
    name: consul
    state: restarted
  when: override_created.changed

- name: Enable and start Consul service
  systemd:
    name: consul
    enabled: yes
    state: started

- name: Wait for Consul to be ready
  wait_for:
    port: 8501
    delay: 5
    timeout: 30
  when: consul_mode == "server"

- name: Create serf directory
  file:
    path: "{{ consul_data_dir }}/serf"
    state: directory
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: '0755'

- name: Sync gossip key to keyring on server
  shell: |
    consul keyring -install "{{ consul_gossip_key }}" -http-addr=https://127.0.0.1:8501 -ca-file=/etc/consul.d/certs/consul-agent-ca.pem -client-cert=/etc/consul.d/certs/server.pem -client-key=/etc/consul.d/certs/server-key.pem || true
    consul keyring -use "{{ consul_gossip_key }}" -http-addr=https://127.0.0.1:8501 -ca-file=/etc/consul.d/certs/consul-agent-ca.pem -client-cert=/etc/consul.d/certs/server.pem -client-key=/etc/consul.d/certs/server-key.pem
  when: consul_mode == "server"
  become_user: "{{ consul_user }}"
  ignore_errors: yes

- name: Remove old gossip keys from keyring
  shell: |
    for key in $(consul keyring -list -http-addr=https://127.0.0.1:8501 -ca-file=/etc/consul.d/certs/consul-agent-ca.pem -client-cert=/etc/consul.d/certs/server.pem -client-key=/etc/consul.d/certs/server-key.pem | grep -v "{{ consul_gossip_key }}" | grep -E "^  [A-Za-z0-9+/=]{44}" | awk '{print $1}'); do
      consul keyring -remove "$key" -http-addr=https://127.0.0.1:8501 -ca-file=/etc/consul.d/certs/consul-agent-ca.pem -client-cert=/etc/consul.d/certs/server.pem -client-key=/etc/consul.d/certs/server-key.pem || true
    done
  when: consul_mode == "server"
  become_user: "{{ consul_user }}"
  ignore_errors: yes

- name: Copy ACL token to all nodes
  copy:
    content: "{{ consul_acl_token }}"
    dest: /tmp/consul_acl_token.txt
    mode: '0644'
    
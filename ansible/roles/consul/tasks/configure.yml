---
- name: Create consul user
  user:
    name: "{{ consul_user }}"
    system: yes
    shell: /bin/false

- name: Create consul directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: 0755
  loop:
    - "{{ consul_config_dir }}"
    - "{{ consul_config_dir }}/certs" 
    - "{{ consul_data_dir }}"

# TLS certificates
- name: Copy CA certificate
  copy:
    src: /tmp/consul-certs/consul-agent-ca.pem
    dest: "{{ consul_config_dir }}/certs/consul-agent-ca.pem"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: '0644'

- name: Copy server TLS files
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: "{{ item.mode }}"
  loop:
    - { src: "/tmp/consul-certs/{{ consul_datacenter }}-server-consul-0.pem", dest: "{{ consul_config_dir }}/certs/server.pem", mode: '0644' }
    - { src: "/tmp/consul-certs/{{ consul_datacenter }}-server-consul-0-key.pem", dest: "{{ consul_config_dir }}/certs/server-key.pem", mode: '0600' }
  when: consul_mode == "server"

- name: Copy client TLS files
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: "{{ item.mode }}"
  loop:
    - { src: "/tmp/consul-certs/{{ consul_datacenter }}-client-consul-0.pem", dest: "{{ consul_config_dir }}/certs/client.pem", mode: '0644' }
    - { src: "/tmp/consul-certs/{{ consul_datacenter }}-client-consul-0-key.pem", dest: "{{ consul_config_dir }}/certs/client-key.pem", mode: '0600' }
  when: consul_mode == "client"

- name: Deploy Consul server config
  template:
    src: server_consul.hcl.j2
    dest: "{{ consul_config_dir }}/consul.hcl"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: '0644' 
  when: consul_mode == "server"
  register: server_config_changed
  notify: Restart consul

- name: Force gossip key update on server
  shell: |
    consul keyring -install "{{ consul_gossip_key }}" || true
    consul keyring -use "{{ consul_gossip_key }}"
  when: 
    - consul_mode == "server"
    - server_config_changed.changed
  ignore_errors: yes

- name: Deploy Consul client config
  template:
    src: client_consul.hcl.j2
    dest: "{{ consul_config_dir }}/consul.hcl"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: '0644'
  when: consul_mode == "client"
  notify: Restart consul

# TO CHANGE [Service] Type=notify FOR Type=simple
- name: Create systemd override directory for Consul
  file:
    path: /etc/systemd/system/consul.service.d
    state: directory
    mode: '0755'

- name: Override Consul service type 
  copy:
    content: |
      [Service]
      Type=
      Type=simple
    dest: /etc/systemd/system/consul.service.d/override.conf
    mode: '0644'
  register: override_created

- name: Reload systemd daemon immediately
  systemd:
    daemon_reload: yes
  when: override_created.changed

- name: Restart consul if override changed
  systemd:
    name: consul
    state: restarted
  when: override_created.changed

- name: Enable and start Consul service
  systemd:
    name: consul
    enabled: yes
    state: started
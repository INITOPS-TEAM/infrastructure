- name: Install required packages
  apt:
    name:
      - git
      - python3
      - python3-pip
      - python3-venv
    state: present
    update_cache: yes

- name: Clone application repository
  git:
    repo: "{{ app_repo_url }}"
    dest: "{{ app_dest }}"
    version:  "{{ app_branch }}"
    force: yes
  notify: Restart app

- name: Create virtualenv and install Python dependencies
  ansible.builtin.pip:
    requirements: "{{ python_requirements }}"
    virtualenv: "{{ app_dest }}/venv"
    virtualenv_command: python3 -m venv

- name: Create uploads directory
  file:
    path: "{{ uploads_path }}"
    state: directory
    owner: ansible_user
    group: ansible_user

- name: Create .env file
  copy:
    content: |
      DATABASE_URL={{ database_url }}
      SECRET_KEY={{ flask_secret_key }}
      UPLOAD_FOLDER={{ uploads_path }}
    dest: "{{ app_dest }}/.env"
    owner: ansible_user
    group: ansible_user
    mode: '0644'
  notify: Restart app

- name: Copy systemd service file
  template:
    src: app.service.j2
    dest: "/etc/systemd/system/app.service"
  notify: 
    - Reload systemd
    - Restart app

- name: Enable and start application service
  systemd:
    name: app
    enabled: yes

- name: Register flask-app in Consul
  template:
    src: flask-app.json.j2
    dest: "{{ consul_config_dir }}/flask-app.json"
    owner: "{{ consul_user }}"
    group: "{{ consul_group }}"
    mode: '0644'
  notify: Restart consul